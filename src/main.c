//
// This file is part of the GNU ARM Eclipse distribution.
// Copyright (c) 2014 Liviu Ionescu.
//
// STM32F103RCT6模拟GBA Cartridge
// 
// GBA      STM32F103RCT6       PC
// VCC -------- VCC3.3
//              VCC5.0 -------- VCC
// /WD
// /RD -------- PA11
// /CS
// AD0~AD15 --- PC0~PC15
// A16~A23  --- PA8~PA15
// /CS2
// IRQ
// GND -------- GND ----------- GND
//              PA9 ----------- TX
//              PA10 ---------- RX

#include "stm32f10x.h"

#define BUS_RD (GPIOC->IDR & 0x0002)
#define BUS_WR (GPIOC->IDR & 0x0004)
#define ADDR_IN GPIOD->IDR
#define DATA_IN GPIOE->IDR
#define DATA_OUT GPIOE->ODR
#define SET_DATA_MODE_IN GPIOE->MODER = 0x00000000;
#define SET_DATA_MODE_OUT GPIOE->MODER = 0x55550000;

// 在GBA画一条直线，已经包含GBA Header
u8 const rom[] = {
    0x2E, 0x00, 0x00, 0xEA, 0x24, 0xFF, 0xAE, 0x51, 0x69, 0x9A, 0xA2, 0x21, 0x3D, 0x84, 0x82, 0x0A,
    0x84, 0xE4, 0x09, 0xAD, 0x11, 0x24, 0x8B, 0x98, 0xC0, 0x81, 0x7F, 0x21, 0xA3, 0x52, 0xBE, 0x19,
    0x93, 0x09, 0xCE, 0x20, 0x10, 0x46, 0x4A, 0x4A, 0xF8, 0x27, 0x31, 0xEC, 0x58, 0xC7, 0xE8, 0x33,
    0x82, 0xE3, 0xCE, 0xBF, 0x85, 0xF4, 0xDF, 0x94, 0xCE, 0x4B, 0x09, 0xC1, 0x94, 0x56, 0x8A, 0xC0,
    0x13, 0x72, 0xA7, 0xFC, 0x9F, 0x84, 0x4D, 0x73, 0xA3, 0xCA, 0x9A, 0x61, 0x58, 0x97, 0xA3, 0x27,
    0xFC, 0x03, 0x98, 0x76, 0x23, 0x1D, 0xC7, 0x61, 0x03, 0x04, 0xAE, 0x56, 0xBF, 0x38, 0x84, 0x00,
    0x40, 0xA7, 0x0E, 0xFD, 0xFF, 0x52, 0xFE, 0x03, 0x6F, 0x95, 0x30, 0xF1, 0x97, 0xFB, 0xC0, 0x85,
    0x60, 0xD6, 0x80, 0x25, 0xA9, 0x63, 0xBE, 0x03, 0x01, 0x4E, 0x38, 0xE2, 0xF9, 0xA2, 0x34, 0xFF,
    0xBB, 0x3E, 0x03, 0x44, 0x78, 0x00, 0x90, 0xCB, 0x88, 0x11, 0x3A, 0x94, 0x65, 0xC0, 0x7C, 0x63,
    0x87, 0xF0, 0x3C, 0xAF, 0xD6, 0x25, 0xE4, 0x8B, 0x38, 0x0A, 0xAC, 0x72, 0x21, 0xD4, 0xF8, 0x07,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x30, 0x31, 0x96, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00,
    0x06, 0x00, 0x00, 0xEA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x03, 0xA0, 0xE3, 0x08, 0x02, 0x80, 0xE5, 0x12, 0x00, 0xA0, 0xE3, 0x00, 0xF0, 0x29, 0xE1,
    0xB8, 0xD0, 0x9F, 0xE5, 0x1F, 0x00, 0xA0, 0xE3, 0x00, 0xF0, 0x29, 0xE1, 0xB0, 0xD0, 0x9F, 0xE5,
    0x01, 0x00, 0x8F, 0xE2, 0x10, 0xFF, 0x2F, 0xE1, 0x2B, 0x48, 0x40, 0x01, 0x0B, 0xD2, 0x78, 0x46,
    0x40, 0x01, 0x0D, 0xD3, 0x02, 0x22, 0x12, 0x06, 0x28, 0x4B, 0x9B, 0x1A, 0x16, 0x1C, 0x91, 0x00,
    0x00, 0xF0, 0x3C, 0xF8, 0x30, 0x47, 0x40, 0x21, 0x09, 0x03, 0xC8, 0x01, 0x00, 0xF0, 0x2B, 0xF8,
    0x23, 0x48, 0x24, 0x49, 0x09, 0x1A, 0x00, 0xF0, 0x26, 0xF8, 0x23, 0x48, 0x23, 0x49, 0x09, 0x1A,
    0x00, 0xF0, 0x21, 0xF8, 0x22, 0x49, 0x23, 0x4A, 0x23, 0x4C, 0x00, 0xF0, 0x26, 0xF8, 0x23, 0x49,
    0x23, 0x4A, 0x24, 0x4C, 0x00, 0xF0, 0x21, 0xF8, 0x23, 0x4A, 0x24, 0x49, 0x53, 0x1A, 0x02, 0xD0,
    0x23, 0x4A, 0x00, 0xF0, 0x1B, 0xF8, 0x23, 0x49, 0x23, 0x4A, 0x24, 0x4C, 0x00, 0xF0, 0x15, 0xF8,
    0x23, 0x49, 0x24, 0x48, 0x08, 0x60, 0x24, 0x4B, 0x00, 0xF0, 0x0E, 0xF8, 0x00, 0x20, 0x00, 0x21,
    0x22, 0x4B, 0x00, 0xF0, 0x09, 0xF8, 0x03, 0x22, 0x89, 0x18, 0x91, 0x43, 0x03, 0xD0, 0x00, 0x22,
    0x04, 0xC0, 0x04, 0x39, 0xFC, 0xD1, 0x70, 0x47, 0x18, 0x47, 0xA3, 0x1A, 0x03, 0x20, 0x1B, 0x18,
    0x83, 0x43, 0x03, 0xD0, 0x01, 0xC9, 0x01, 0xC2, 0x04, 0x3B, 0xFB, 0xD1, 0x70, 0x47, 0xC0, 0x46,
    0xA0, 0x7F, 0x00, 0x03, 0x00, 0x7F, 0x00, 0x03, 0x00, 0x00, 0x00, 0x02, 0x8C, 0x03, 0x00, 0x02,
    0x00, 0x00, 0x00, 0x03, 0x24, 0x00, 0x00, 0x03, 0x8C, 0x03, 0x00, 0x02, 0x8C, 0x03, 0x00, 0x02,
    0x88, 0x03, 0x00, 0x02, 0x24, 0x00, 0x00, 0x03, 0x28, 0x00, 0x00, 0x03, 0x88, 0x03, 0x00, 0x02,
    0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x8C, 0x03, 0x00, 0x02, 0x8C, 0x03, 0x00, 0x02,
    0x28, 0x00, 0x00, 0x03, 0x8C, 0x03, 0x00, 0x02, 0x8C, 0x03, 0x00, 0x02, 0x8C, 0x03, 0x00, 0x02,
    0x20, 0x00, 0x00, 0x03, 0x00, 0x00, 0x04, 0x02, 0xF1, 0x02, 0x00, 0x02, 0x49, 0x03, 0x00, 0x02,
    0xF8, 0xB5, 0xC0, 0x46, 0xF8, 0xBC, 0x08, 0xBC, 0x9E, 0x46, 0x70, 0x47, 0x08, 0xB5, 0x07, 0x4B,
    0x07, 0x48, 0x03, 0x33, 0x1B, 0x1A, 0x06, 0x2B, 0x04, 0xD9, 0x06, 0x4B, 0x00, 0x2B, 0x01, 0xD0,
    0x00, 0xF0, 0x5C, 0xF8, 0x08, 0xBC, 0x01, 0xBC, 0x00, 0x47, 0xC0, 0x46, 0x28, 0x00, 0x00, 0x03,
    0x28, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x08, 0x48, 0x09, 0x49, 0x09, 0x1A, 0x89, 0x10,
    0x08, 0xB5, 0xCB, 0x0F, 0x59, 0x18, 0x49, 0x10, 0x04, 0xD0, 0x06, 0x4B, 0x00, 0x2B, 0x01, 0xD0,
    0x00, 0xF0, 0x44, 0xF8, 0x08, 0xBC, 0x01, 0xBC, 0x00, 0x47, 0xC0, 0x46, 0x28, 0x00, 0x00, 0x03,
    0x28, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x10, 0xB5, 0x08, 0x4C, 0x23, 0x78, 0x00, 0x2B,
    0x09, 0xD1, 0xFF, 0xF7, 0xCB, 0xFF, 0x06, 0x4B, 0x00, 0x2B, 0x02, 0xD0, 0x05, 0x48, 0x00, 0xE0,
    0x00, 0xBF, 0x01, 0x23, 0x23, 0x70, 0x10, 0xBC, 0x01, 0xBC, 0x00, 0x47, 0x00, 0x00, 0x00, 0x03,
    0x00, 0x00, 0x00, 0x00, 0x84, 0x03, 0x00, 0x02, 0x08, 0xB5, 0x0B, 0x4B, 0x00, 0x2B, 0x03, 0xD0,
    0x0A, 0x48, 0x0B, 0x49, 0x00, 0xE0, 0x00, 0xBF, 0x0A, 0x48, 0x03, 0x68, 0x00, 0x2B, 0x04, 0xD1,
    0xFF, 0xF7, 0xC2, 0xFF, 0x08, 0xBC, 0x01, 0xBC, 0x00, 0x47, 0x07, 0x4B, 0x00, 0x2B, 0xF7, 0xD0,
    0x00, 0xF0, 0x0C, 0xF8, 0xF4, 0xE7, 0xC0, 0x46, 0x00, 0x00, 0x00, 0x00, 0x84, 0x03, 0x00, 0x02,
    0x04, 0x00, 0x00, 0x03, 0x80, 0x03, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x18, 0x47, 0xC0, 0x46,
    0x70, 0xB5, 0x10, 0x4E, 0x10, 0x4D, 0xAD, 0x1B, 0xAD, 0x10, 0x00, 0x24, 0x00, 0x2D, 0x06, 0xD0,
    0xA3, 0x00, 0xF3, 0x58, 0x01, 0x34, 0x00, 0xF0, 0x1D, 0xF8, 0xA5, 0x42, 0xF8, 0xD1, 0xFF, 0xF7,
    0x7F, 0xFF, 0x0A, 0x4E, 0x0A, 0x4D, 0xAD, 0x1B, 0xAD, 0x10, 0x00, 0x24, 0x00, 0x2D, 0x06, 0xD0,
    0xA3, 0x00, 0xF3, 0x58, 0x01, 0x34, 0x00, 0xF0, 0x0D, 0xF8, 0xA5, 0x42, 0xF8, 0xD1, 0x70, 0xBC,
    0x01, 0xBC, 0x00, 0x47, 0x78, 0x03, 0x00, 0x02, 0x78, 0x03, 0x00, 0x02, 0x78, 0x03, 0x00, 0x02,
    0x7C, 0x03, 0x00, 0x02, 0x18, 0x47, 0xC0, 0x46, 0x80, 0x23, 0x1F, 0x21, 0x04, 0x4A, 0xDB, 0x04,
    0x1A, 0x60, 0x04, 0x4B, 0x04, 0x4A, 0x19, 0x80, 0x02, 0x33, 0x93, 0x42, 0xFB, 0xD1, 0xFE, 0xE7,
    0x03, 0x04, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x06, 0xE0, 0x3D, 0x00, 0x06, 0xF8, 0xB5, 0xC0, 0x46,
    0xF8, 0xBC, 0x08, 0xBC, 0x9E, 0x46, 0x70, 0x47, 0xA9, 0x02, 0x00, 0x02, 0x79, 0x02, 0x00, 0x02,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
static u8 fac_us = 0;  //us延时倍乘数
static u16 fac_ms = 0; //ms

/**************************************************
Name: delay_init
功能：应用程序延时函数初始化，包括为滴答时钟准备相关数值
参数：u8 SYSCLK
返回：None
***************************************************/
void delay_init(u8 SYSCLK)
{
  SysTick->CTRL &= 0xfffffffb; //设置滴答时钟的时钟源：bit 2清空，选择外部时钟HCLK/8
  fac_us = SYSCLK / 8;
  fac_ms = (u16)fac_us * 1000;
}
/**************************************************
名字：delay_ms
共能：应用程序ms级别的延时实现
参数：u16 nms
返回：None
***************************************************/
void delay_ms(u16 nms)
{
  u32 temp;
  SysTick->LOAD = (u32)nms * fac_ms; //时间加载
  SysTick->VAL = 0x00;               //清空计数器
  SysTick->CTRL = 0x01;              //开始倒数
  do
  {
    temp = SysTick->CTRL;
  } while (temp & 0x01 && !(temp & (1 << 16))); //等待时间到达
  SysTick->CTRL = 0x00;                         //关闭计数器
  SysTick->VAL = 0X00;                          //清空计数器
}

void SetInput();
void SetOutput();

int main(int argc, char *argv[])
{
  // 初始化时钟，默认72MHz
  SystemInit();

  delay_init(72);

  // 打开时钟
  RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);
  RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOC, ENABLE);
  RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOD, ENABLE);
  // 串口
  RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1, ENABLE);
  // 中断
  RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO, ENABLE);

  // 初始化GPIO
  GPIO_InitTypeDef GPIO_InitStructure;

  //初始化GPIOA
  //USART1 Tx(PA.09)
  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9;
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;
  GPIO_Init(GPIOA, &GPIO_InitStructure);
  //USART1 Rx(PA.10)
  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10;
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;
  GPIO_Init(GPIOA, &GPIO_InitStructure);
  // PA0~PA7
  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0 | GPIO_Pin_1 | GPIO_Pin_2 | GPIO_Pin_3 | GPIO_Pin_4 | GPIO_Pin_5 | GPIO_Pin_6 | GPIO_Pin_7;
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;
  GPIO_Init(GPIOA, &GPIO_InitStructure);

  // 初始化GPIOC
  // PC0~PC15
  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0 | GPIO_Pin_1 | GPIO_Pin_2 | GPIO_Pin_3 | GPIO_Pin_4 | GPIO_Pin_5 | GPIO_Pin_6 | GPIO_Pin_7 | GPIO_Pin_8 | GPIO_Pin_9 | GPIO_Pin_10 | GPIO_Pin_11 | GPIO_Pin_12 | GPIO_Pin_13 | GPIO_Pin_14 | GPIO_Pin_15;
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;
  GPIO_Init(GPIOC, &GPIO_InitStructure);

  // 初始化GPIOD
  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_2;
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_10MHz;
  GPIO_Init(GPIOD, &GPIO_InitStructure);

  // 中断端口PA11
  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_11;
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
  GPIO_Init(GPIOA, &GPIO_InitStructure);

  //USART1配置
  USART_InitTypeDef USART_InitStructure;

  USART_InitStructure.USART_BaudRate = 115200;
  USART_InitStructure.USART_WordLength = USART_WordLength_8b;
  USART_InitStructure.USART_StopBits = USART_StopBits_1;
  USART_InitStructure.USART_Parity = USART_Parity_No;
  USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;
  USART_InitStructure.USART_Mode = USART_Mode_Tx | USART_Mode_Rx;
  USART_Init(USART1, &USART_InitStructure);
  USART_Cmd(USART1, ENABLE);

  GPIO_EXTILineConfig(GPIO_PortSourceGPIOA, GPIO_PinSource11);

  EXTI_InitTypeDef EXTI_InitStructure;
  EXTI_InitStructure.EXTI_Line = EXTI_Line11;
  EXTI_InitStructure.EXTI_Mode = EXTI_Mode_Interrupt;
  EXTI_InitStructure.EXTI_Trigger = EXTI_Trigger_Rising;
  EXTI_InitStructure.EXTI_LineCmd = ENABLE;
  EXTI_Init(&EXTI_InitStructure);

  NVIC_InitTypeDef NVIC_InitStructure;
  NVIC_PriorityGroupConfig(NVIC_PriorityGroup_0);

  NVIC_InitStructure.NVIC_IRQChannel = EXTI15_10_IRQn; //PPP外部中断线
  NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;
  NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0;
  NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
  NVIC_Init(&NVIC_InitStructure);

  // Infinite loop
  while (1)
  {
    delay_ms(100);
    GPIO_SetBits(GPIOD, GPIO_Pin_2);

    delay_ms(100);
    // 设置低
    GPIO_ResetBits(GPIOD, GPIO_Pin_2);
  }
}

void EXTI15_10_IRQHandler(void)
{
  if (EXTI_GetITStatus(EXTI_Line11) != RESET)
  {
    EXTI_ClearITPendingBit(EXTI_Line11); //清除标志

    asm("nop");
    asm("nop");
    uint16_t dat = GPIO_ReadInputData(GPIOC);
    USART_SendData(USART1, dat >> 8);
    USART_SendData(USART1, dat & 0xFF);
  }
}
